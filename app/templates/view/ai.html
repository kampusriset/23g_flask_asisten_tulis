{% extends "base/sidebar.html" %}

{% block content %}
<h2 style="margin-top: 30px;"> AI Assistant</h2>
<p>Interaksi AI — ketik prompt Anda, klik Kirim, dan lihat balasan.</p>

<!-- Preset quick prompts (5 boxes) -->
<div class="mt-3 container">
    <h6 class="mb-2">Prompt Cepat</h6>
    <div class="row g-2 justify-content-center">
        <div class="col-6 col-md-2">
            <div class="card preset-box preset-template h-100 text-center p-2" data-prompt="Ringkas: " data-mode="summary" role="button" tabindex="0" aria-label="AI Ringkasan" style="cursor:pointer;">
                <div class="card-body py-2">
                    <i class="fi fi-rr-list" style="font-size:20px"></i>
                    <div class="small mt-1">AI Ringkasan</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-2">
            <div class="card preset-box preset-template h-100 text-center p-2" data-prompt="Terjemah: " data-mode="translate" role="button" tabindex="0" aria-label="AI Translate" style="cursor:pointer;">
                <div class="card-body py-2">
                    <i class="fi fi-rr-translate" style="font-size:20px"></i>
                    <div class="small mt-1">AI Translate</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-2">
            <div class="card preset-box preset-template h-100 text-center p-2" data-prompt="Perbaiki tata bahasa: " data-mode="grammar" role="button" tabindex="0" aria-label="AI Grammar" style="cursor:pointer;">
                <div class="card-body py-2">
                    <i class="fi fi-rr-edit" style="font-size:20px"></i>
                    <div class="small mt-1">AI Grammar</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-2">
            <div class="card preset-box empty h-100 text-center p-2" role="button" tabindex="0" aria-label="Kotak kosong 1" style="cursor:pointer; border:1px dashed #ced4da;">
                <div class="card-body py-2">
                    <i class="fi fi-rr-plus" style="font-size:20px"></i>
                    <div class="small mt-1 text-muted">Kosong</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-2">
            <div class="card preset-box empty h-100 text-center p-2" role="button" tabindex="0" aria-label="Kotak kosong 2" style="cursor:pointer; border:1px dashed #ced4da;">
                <div class="card-body py-2">
                    <i class="fi fi-rr-plus" style="font-size:20px"></i>
                    <div class="small mt-1 text-muted">Kosong</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mt-3 mx-auto" style="max-width: 900px; width: 100%; margin-bottom:140px;">
    <div class="card-body">
        <style>
            /* Chat message layout: user (right) and AI (left) */
            #chat{min-height:220px; max-height:480px; overflow:auto; border:1px solid #eee; padding:18px; border-radius:6px; background:#fafafa; width:100%}
            #chat .message{margin-bottom:10px; display:flex; width:100%;}
            #chat .message .bubble{padding:10px 12px; border-radius:12px; max-width:75%; word-break:break-word}
            /* Left (AI) aligned */
            #chat .message.ai{justify-content:flex-start}
            #chat .message.ai .bubble{background:#e9ecef; color:#212529; border-bottom-left-radius:6px; margin-right:auto}
            /* Right (User) aligned */
            #chat .message.user{justify-content:flex-end}
            #chat .message.user .bubble{background:#0d6efd; color:#fff; border-bottom-right-radius:6px; margin-left:auto}
            #chat .message.system{justify-content:center}
            #chat .who{font-weight:600; font-size:0.85rem; margin-bottom:4px}
        </style>

        <div id="chat">
            <!-- Messages akan muncul di sini -->
        </div>

        <div class="input-group mt-3 d-flex align-items-center flex-nowrap" style="gap:0.5rem;">
            <div id="prompt-wrapper" class="flex-grow-1">
                <!-- Stable comment form: always use textarea so layout doesn't change -->
                <textarea id="prompt_textarea" class="form-control" rows="4" placeholder="Tulis komentar atau perintah... (Ctrl+Enter untuk mengirim)"></textarea>
            </div>
            <button id="sendBtn" class="btn btn-primary">Kirim</button>
        </div>

        <div id="status" class="mt-2 text-muted small">Status: siap</div>
    </div>
    <div class="card-footer text-muted small">
        <strong>Catatan:</strong> Server menggunakan **Gemini (Google Generative)** masih dalam tahap pengembangan.
        <div class="mt-1">Provider tersedia:
            {% if gemini_available %}
                <span class="badge bg-success">Gemini</span>
            {% else %}
                <span class="text-muted">(tidak ada)</span>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
    const promptInput = document.getElementById('prompt_textarea');
    const sendBtn = document.getElementById('sendBtn');
    const chat = document.getElementById('chat');
    const status = document.getElementById('status');

    function appendMessage(who, text){
        // who: 'Anda' | 'AI' | 'System'
        const msg = document.createElement('div');
        const cls = (who === 'Anda') ? 'user' : (who === 'AI' ? 'ai' : 'system');
        msg.className = 'message ' + cls;

        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        const safe = DOMPurify ? DOMPurify.sanitize(text) : text;
        bubble.innerHTML = `<div class="who">${who}</div><div>${safe}</div>`;

        msg.appendChild(bubble);
        chat.appendChild(msg);
        chat.scrollTop = chat.scrollHeight;
    }

    // Stable prompt helpers — always use textarea
    const promptTextarea = document.getElementById('prompt_textarea');
    const promptWrapper = document.getElementById('prompt-wrapper');

    function getPromptValue(){
        return promptTextarea.value.trim();
    }

    function setPromptValue(v){
        promptTextarea.value = v || '';
    }

    function clearPrompt(){
        promptTextarea.value = '';
    }

    async function sendPrompt(){
        const prompt = getPromptValue();
        if(!prompt) return;
        appendMessage('Anda', prompt);
        clearPrompt();
        sendBtn.disabled = true;
        status.textContent = 'Mengirim...';

        try{
            const res = await fetch('/ai/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt })
            });
            if(!res.ok){
                const err = await res.json().catch(()=>({message:res.statusText}));
                appendMessage('System', 'Error: ' + (err.message || JSON.stringify(err)));
            } else {
                const data = await res.json();
                appendMessage('AI', data.reply || '(tidak ada balasan)');
                if(data.provider){
                    status.textContent = `Selesai (via ${data.provider})`;
                } else {
                    status.textContent = 'Selesai';
                }
            }
        } catch(e){
            appendMessage('System', 'Gagal menghubungi server: '+e.message);
        } finally{
            sendBtn.disabled = false;
            status.textContent = 'Siap';
            promptInput.focus();
        }
    }

    // Kirim saat tombol diklik
    sendBtn.addEventListener('click', sendPrompt);
    // Pada textarea: kirim saat Ctrl+Enter (atau Cmd+Enter)
    promptTextarea.addEventListener('keydown', function(e){ if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)){ e.preventDefault(); sendPrompt(); } });

    // Preset prompt boxes -> klik untuk isi/template/kirim (form tetap stabil)
    document.querySelectorAll('.preset-box').forEach(box => {
        box.addEventListener('click', () => {
            const p = box.getAttribute('data-prompt');

            if (box.classList.contains('preset-template')) {
                // populate textarea only (do not change layout)
                setPromptValue(p || '');
                promptTextarea.focus();
                status.textContent = p ? 'Template dimuat — lengkapi prompt lalu tekan Ctrl+Enter untuk Kirim' : 'Kotak kosong — isi prompt lalu tekan Ctrl+Enter untuk Kirim';
                return;
            }

            if (!p) {
                // empty placeholder: fokuskan textarea
                promptTextarea.focus();
                status.textContent = 'Kotak kosong — isi prompt lalu tekan Ctrl+Enter untuk Kirim';
                return;
            }

            // otherwise fill textarea and send
            setPromptValue(p);
            sendPrompt();
        });
        // keyboard support
        box.addEventListener('keypress', (e) => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); box.click(); } });
    });
});
</script>

<!-- DOMPurify untuk sanitasi simple jika tersedia (tidak wajib) -->
<script>if(typeof DOMPurify === 'undefined'){window.DOMPurify = null;}</script>

<!-- Fixed send widget removed per request (no fixed bottom-right comment form) -->
{% endblock %}
