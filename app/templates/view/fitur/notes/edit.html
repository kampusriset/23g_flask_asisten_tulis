{% extends "base/sidebar.html" %}

{% block sidebar %}
<div class="px-3 py-2">
    <a href="{{ url_for('notes_bp.edit', note_id=note.id) }}"
        class="block bg-gray-900 text-white px-3 py-2 rounded text-sm font-medium">
        ✏️ {{ note.title or "Catatan Baru" }}
    </a>
</div>
{% endblock %}

{% block content %}
<div class="flex justify-center mt-12">
    <div class="w-full max-w-3xl px-4">

        <form method="POST" id="saveForm">

            <!-- JUDUL -->
            <div class="mb-4">
                <input type="text" name="title"
                    class="w-full bg-transparent border-b border-gray-200 text-2xl font-bold py-2 focus:outline-none focus:border-b-2 focus:border-blue-500"
                    placeholder="Judul catatan baru..." value="{{ note.title }}">
            </div>

            <!-- KONTEN -->
            <div class="mb-4 relative min-h-[300px]">

                <!-- GHOST SUGGESTION -->
                <div id="ghost"
                    class="absolute inset-0 text-gray-400 whitespace-pre-wrap pointer-events-none bg-transparent"></div>

                <!-- EDITOR ASLI -->
                <div id="editor" contenteditable="true"
                    class="relative min-h-[300px] bg-transparent outline-none whitespace-pre-wrap editable-div text-gray-800"
                    data-placeholder="Tulis apapun disini...">{{ note.content }}</div>

                <input type="hidden" name="content" id="contentHidden">
            </div>

            <div class="flex items-center gap-3">
                <button class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                    type="submit">
                    <i class="fi fi-rr-disk mr-2"></i> Simpan
                </button>
            </div>
        </form>

        <div class="mt-4">
            <form method="POST" action="{{ url_for('notes_bp.delete', note_id=note.id) }}"
                onsubmit="return confirm('Yakin hapus catatan ini, Bang?')">
                <button class="inline-flex items-center px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                    type="submit">
                    <i class="fi fi-rr-trash mr-2"></i> Hapus
                </button>
            </form>
        </div>
    </div>
</div>

<style>
    /* placeholder untuk div contenteditable */
    .editable-div:empty::before {
        content: attr(data-placeholder);
        color: #9CA3AF;
        /* gray-400 */
        pointer-events: none;
        display: block;
    }

    /* ensure ghost sits behind cursor text but above background */
    #ghost {
        z-index: 0;
        padding: 0.5rem 0;
    }

    #editor {
        z-index: 10;
        padding: 0.5rem 0;
    }
</style>

<script>
    const editor = document.getElementById("editor");
    const ghost = document.getElementById("ghost");
    const hiddenInput = document.getElementById("contentHidden");

    let suggestion = "";
    let debounceTimer = null;
    let lastText = "";

    /* --------------------
       helper
    -------------------- */
    function clearSuggestion() {
        suggestion = "";
        syncGhost();
    }

    function syncGhost() {
        // keep ghost content behind the editor content
        ghost.innerText = editor.innerText + suggestion;
    }

    editor.addEventListener("input", () => {
        syncGhost();
    });

    /* --------------------
       key handling
    -------------------- */
    editor.addEventListener("keydown", (e) => {
        if (e.key === "Tab" && suggestion) {
            e.preventDefault();
            editor.innerText += suggestion;
            clearSuggestion();
            moveCursorToEnd(editor);
            return;
        }

        if (suggestion && (e.key.length === 1 || e.key === "Backspace" || e.key === "Enter")) {
            clearSuggestion();
            return;
        }

        if (suggestion && ["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown", "Escape"].includes(e.key)) {
            clearSuggestion();
            return;
        }

        if (e.key === " ") {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const lastLine = editor.innerText.split("\n").pop().trim();
                if (lastLine.length < 3 || lastLine === lastText) return;
                lastText = lastLine;
                requestSuggestion(lastLine);
            }, 2000);
        }
    });

    /* --------------------
       call backend
    -------------------- */
    async function requestSuggestion(text) {
        try {
            const res = await fetch(`/notes/{{ note.id }}/suggest`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text })
            });
            const data = await res.json();
            suggestion = data.suggestion ? "" + data.suggestion : "";
            syncGhost();
        } catch (err) {
            console.error("AI error:", err);
        }
    }

    /* --------------------
       cursor helper
    -------------------- */
    function moveCursorToEnd(el) {
        el.focus();
        const range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
    }

    /* --------------------
       submit → DB
    -------------------- */
    document.getElementById("saveForm").addEventListener("submit", () => {
        hiddenInput.value = editor.innerText;
    });
</script>

{% endblock %}