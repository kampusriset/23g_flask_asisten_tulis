{% extends "base/sidebar.html" %}

{% block sidebar %}
<div class="px-3 py-2">
    <a href="{{ url_for('notes_bp.edit', note_id=note.id) }}"
        class="block bg-gray-900 text-white px-3 py-2 rounded text-sm font-medium">
        ‚úèÔ∏è {{ note.title or "Catatan Baru" }}
    </a>
</div>
{% endblock %}

{% block content %}

<div class="flex justify-center mt-12">
    <div class="w-full max-w-3xl px-4">

        <form method="POST" id="saveForm">

            <!-- JUDUL -->
            <div class="mb-4">
                <input type="text" name="title"
                    class="w-full bg-transparent border-b border-gray-200 text-2xl font-bold py-2 focus:outline-none focus:border-b-2 focus:border-blue-500"
                    placeholder="Judul catatan baru..." value="{{ note.title }}">
            </div>

            <!-- KONTEN -->
            <div class="mb-4 relative min-h-[300px]">

                <!-- GHOST SUGGESTION -->
                <div id="ghost"
                    class="absolute inset-0 text-gray-400 whitespace-pre-wrap pointer-events-none bg-transparent"></div>

                <!-- EDITOR ASLI -->
                <div id="editor" contenteditable="true"
                    class="relative min-h-[300px] bg-transparent outline-none whitespace-pre-wrap editable-div text-gray-800"
                    data-placeholder="Tulis apapun disini...">{{ note.content }}</div>

                <input type="hidden" name="content" id="contentHidden">
            </div>

            <div class="flex items-center gap-3">
                <button class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                    type="submit">
                    <i class="fi fi-rr-disk mr-2"></i> Simpan
                </button>
            </div>
        </form>

        <div class="mt-4">
            <form method="POST" action="{{ url_for('notes_bp.delete', note_id=note.id) }}"
                onsubmit="return confirm('Yakin hapus catatan ini, Bang?')">
                <button class="inline-flex items-center px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                    type="submit">
                    <i class="fi fi-rr-trash mr-2"></i> Hapus
                </button>
                <div class="flex items-center gap-3 mt-3">
                    <button type="button" id="summarizeBtn"
                        class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Ringkas AI
                    </button>
                </div>
                <div class="flex items-center gap-3 mt-3">
                    <button type="button" id="bulletBtn"
                        class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                        Bullet AI
                    </button>
                </div>
            </form>
            <!-- MODAL RINGKASAN -->
            <div id="summaryModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
                <div class="bg-white rounded-lg max-w-xl w-full p-5">
                    <h3 class="text-lg font-bold mb-2">Ringkasan AI</h3>

                    <div id="summaryResult"
                        class="whitespace-pre-wrap text-gray-800 border rounded p-3 mb-4 min-h-[120px]">
                    </div>

                    <div class="flex justify-end gap-2">
                        <button id="cancelSummary" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">
                            Batalkan
                        </button>
                        <button id="applySummary" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                            Terapkan
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    /* placeholder untuk div contenteditable */
    .editable-div:empty::before {
        content: attr(data-placeholder);
        color: #9CA3AF;
        /* gray-400 */
        pointer-events: none;
        display: block;
    }

    /* ensure ghost sits behind cursor text but above background */
    #ghost {
        z-index: 0;
        padding: 0.5rem 0;
    }

    #editor {
        z-index: 10;
        padding: 0.5rem 0;
    }
</style>

<script>
    const bulletBtn = document.getElementById("bulletBtn");

    bulletBtn.addEventListener("click", async () => {
        const content = editor.innerText.trim();
        if (content.length < 20) {
            alert("Catatan terlalu pendek buat dibuat bullet point");
            return;
        }

        summaryResult.innerText = "Sedang membuat bullet point...";
        modal.classList.remove("hidden");
        modal.classList.add("flex");

        try {
            const res = await fetch(`/notes/{{ note.id }}/summarize-bullet`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: content })
            });

            const data = await res.json();
            summaryText = data.summary || "";
            summaryResult.innerText = summaryText || "Gagal bikin bullet point";

        } catch (err) {
            summaryResult.innerText = "Error AI";
        }
    });
</script>


<script>
    const summarizeBtn = document.getElementById("summarizeBtn");
    const modal = document.getElementById("summaryModal");
    const summaryResult = document.getElementById("summaryResult");
    const cancelSummary = document.getElementById("cancelSummary");
    const applySummary = document.getElementById("applySummary");

    let summaryText = "";

    summarizeBtn.addEventListener("click", async () => {
        const content = editor.innerText.trim();
        if (content.length < 20) {
            alert("Catatan terlalu pendek buat diringkas");
            return;
        }

        summaryResult.innerText = "Sedang meringkas catatanmu...";
        modal.classList.remove("hidden");
        modal.classList.add("flex");

        try {
            const res = await fetch(`/notes/{{ note.id }}/summarize`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: content })
            });

            const data = await res.json();
            summaryText = data.summary || "";
            summaryResult.innerText = summaryText || "Gagal meringkas";

        } catch (err) {
            summaryResult.innerText = "Error AI";
        }
    });

    cancelSummary.addEventListener("click", () => {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
        summaryText = "";
    });

    applySummary.addEventListener("click", () => {
        if (!summaryText) return;

        // ganti isi editor
        editor.innerText = summaryText;
        syncGhost();

        // set hidden input
        hiddenInput.value = summaryText;

        // tutup modal
        modal.classList.add("hidden");
        modal.classList.remove("flex");

        // AUTO SAVE üî•
        document.getElementById("saveForm").submit();
    });
</script>

<script>
    const editor = document.getElementById("editor");
    const ghost = document.getElementById("ghost");
    const hiddenInput = document.getElementById("contentHidden");
    const titleInput = document.querySelector('input[name="title"]');

    let suggestion = "";
    let debounceTimer = null;
    let lastText = "";

    let isDirty = false;
    let autoSaveTimer = null;
    const AUTO_SAVE_DELAY = 3000; // 3 detik (bebas Bang mau 2‚Äì5)

    function markDirty() {
        isDirty = true;
        showSaving();

        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            autoSave();
        }, AUTO_SAVE_DELAY);
    }

    editor.addEventListener("input", () => {
        syncGhost();
        markDirty();
    });

    titleInput.addEventListener("input", () => {
        markDirty();
    });

    async function autoSave() {
        if (!isDirty) return;

        // isi hidden content & title
        hiddenInput.value = editor.innerHTML;

        document.querySelector('input[name="title"]').value =
            document.querySelector('input[name="title"]').value.trim();

        try {
            await fetch(`/notes/{{ note.id }}`, {
                method: "POST",
                body: new FormData(document.getElementById("saveForm"))
            });

            isDirty = false;
            showSaved();

        } catch (err) {
            showSaveError();
            console.error("Auto-save error", err);
        }
    }



    window.addEventListener("beforeunload", (e) => {
        if (isDirty) {
            hiddenInput.value = editor.innerText;

            navigator.sendBeacon(
                `/notes/{{ note.id }}`,
                new URLSearchParams(new FormData(saveForm))
            );
        }
    });


    const currentNoteId = "{{ note.id }}";

    const sidebarTitle = document.querySelector(
        `.note-link[data-note-id="${currentNoteId}"] .note-title`
    );

    if (titleInput && sidebarTitle) {
        titleInput.addEventListener("input", () => {
            sidebarTitle.textContent =
                titleInput.value.trim() || "Catatan Baru";
            markDirty();
        });
    }






    /* --------------------
       helper
    -------------------- */
    function clearSuggestion() {
        suggestion = "";
        syncGhost();
    }

    function syncGhost() {
        // keep ghost content behind the editor content
        ghost.innerText = editor.innerText + suggestion;
    }

    editor.addEventListener("input", () => {
        syncGhost();
    });

    /* --------------------
       key handling
    -------------------- */
    editor.addEventListener("keydown", (e) => {
        if (e.key === "Tab" && suggestion) {
            e.preventDefault();
            editor.innerText += suggestion;
            clearSuggestion();
            moveCursorToEnd(editor);
            markDirty();
            return;
        }

        if (suggestion && (e.key.length === 1 || e.key === "Backspace" || e.key === "Enter")) {
            clearSuggestion();
            return;
        }

        if (suggestion && ["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown", "Escape"].includes(e.key)) {
            clearSuggestion();
            return;
        }

        if (e.key === " ") {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const lastLine = editor.innerText.split("\n").pop().trim();
                if (lastLine.length < 3 || lastLine === lastText) return;
                lastText = lastLine;
                requestSuggestion(lastLine);
            }, 2000);
        }
    });

    /* --------------------
       call backend
    -------------------- */
    async function requestSuggestion(text) {
        try {
            const res = await fetch(`/notes/{{ note.id }}/suggest`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text })
            });
            const data = await res.json();
            suggestion = data.suggestion ? "" + data.suggestion : "";
            syncGhost();
        } catch (err) {
            console.error("AI error:", err);
        }
    }

    /* --------------------
       cursor helper
    -------------------- */
    function moveCursorToEnd(el) {
        el.focus();
        const range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
    }

    /* --------------------
       submit ‚Üí DB
    -------------------- */
    document.getElementById("saveForm").addEventListener("submit", () => {
        hiddenInput.value = editor.innerText;
    });
</script>

<script>
    document.querySelectorAll("#sidebar a").forEach(link => {
        link.addEventListener("click", (e) => {
            if (!isDirty) return;

            e.preventDefault();

            hiddenInput.value = editor.innerText;

            navigator.sendBeacon(
                `/notes/{{ note.id }}`,
                new URLSearchParams(new FormData(saveForm))
            );

            // kasih delay dikit biar beacon terkirim
            setTimeout(() => {
                window.location.href = link.href;
            }, 50);
        });
    });

</script>

{% endblock %}