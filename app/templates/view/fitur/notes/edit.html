{% extends "base/sidebar.html" %}

{% block sidebar %}
<ul class="list-group list-group-flush">
    <a href="{{ url_for('notes_bp.edit', note_id=note.id) }}" class="list-group-item active">
        ✏️ {{ note.title or "Catatan Baru" }}
    </a>
</ul>
{% endblock %}

{% block content %}

<form method="POST" id="saveForm">
    <div class="mb-3">
        <input type="text" name="title" class="form-control form-control-lg" placeholder="Judul catatan..."
            value="{{ note.title }}">
    </div>

    <div class="mb-3 position-relative">

        <!-- GHOST SUGGESTION (DI DALAM BOX) -->
        <div id="ghost" class="form-control" style="
            min-height:200px;
            white-space:pre-wrap;
            color:#aaa;
            position:absolute;
            top:0;
            left:0;
            pointer-events:none;
            background:transparent;
        ">
        </div>

        <!-- EDITOR ASLI -->
        <div id="editor" contenteditable="true" class="form-control" style="
            min-height:200px;
            background:transparent;
            position:relative;
        ">
            {{ note.content }}
        </div>

        <input type="hidden" name="content" id="contentHidden">
    </div>


    <button class="btn btn-success">
        <i class="fi fi-rr-disk"> Simpan</i>
    </button>
</form>




<hr>

<!-- FORM HAPUS -->
<form method="POST" action="{{ url_for('notes_bp.delete', note_id=note.id) }}"
    onsubmit="return confirm('Yakin hapus catatan ini, Bang?')">
    <button class="btn btn-danger">
        <i class="fi fi-rr-trash"> Hapus</i>
    </button>
</form>

<script>
    const editor = document.getElementById("editor");
    const ghost = document.getElementById("ghost");
    const hiddenInput = document.getElementById("contentHidden");

    let suggestion = "";
    let debounceTimer = null;
    let lastText = "";

    /* --------------------
       helper
    -------------------- */
    function clearSuggestion() {
        suggestion = "";
        ghost.innerText = editor.innerText;
        syncGhost();
    }

    function syncGhost() {
        ghost.innerText = editor.innerText + suggestion;
    }

    function getLastLine(text) {
        const lines = text.split("\n");
        return lines[lines.length - 1];
    }

    /* --------------------
       input update
    -------------------- */
    editor.addEventListener("input", () => {
        syncGhost();
    });

    /* --------------------
       key handling
    -------------------- */
    editor.addEventListener("keydown", (e) => {

        /* TAB → accept */
        if (e.key === "Tab" && suggestion) {
            e.preventDefault();
            editor.innerText += suggestion;
            clearSuggestion();
            moveCursorToEnd(editor);
            return;
        }

        /* kalau user ngetik apa pun selain kontrol → batalin suggestion */
        if (
            suggestion &&
            (
                e.key.length === 1 ||        // huruf, angka, simbol
                e.key === "Backspace" ||
                e.key === "Enter"
            )
        ) {
            clearSuggestion();
            return;
        }

        /* navigasi cursor → batal */
        if (
            suggestion &&
            ["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown", "Escape"].includes(e.key)
        ) {
            clearSuggestion();
            return;
        }

        /* trigger AI hanya via SPACE */
        if (e.key === " ") {
            clearTimeout(debounceTimer);

            debounceTimer = setTimeout(() => {
                const lastLine = editor.innerText.split("\n").pop().trim();
                if (lastLine.length < 3 || lastLine === lastText) return;

                lastText = lastLine;
                requestSuggestion(lastLine);
            }, 2000);
        }
    });

    /* --------------------
       call backend
    -------------------- */
    async function requestSuggestion(text) {
        try {
            console.log("Sending to backend:", text);

            const res = await fetch(`/notes/{{ note.id }}/suggest`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text })
            });

            const data = await res.json();
            suggestion = data.suggestion ? "" + data.suggestion : "";
            syncGhost();

            console.log("AI Suggestion:", suggestion);
        } catch (err) {
            console.error("AI error:", err);
        }
    }

    /* --------------------
       cursor helper
    -------------------- */
    function moveCursorToEnd(el) {
        el.focus();
        const range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
    }

    /* --------------------
       submit → DB
    -------------------- */
    document.getElementById("saveForm").addEventListener("submit", () => {
        hiddenInput.value = editor.innerText;
    });
</script>




{% endblock %}