{% extends "base/sidebar.html" %}

{% block sidebar %}
<ul class="list-group list-group-flush">
    <a href="{{ url_for('notes_bp.edit', note_id=note.id) }}" class="list-group-item active">
        ✏️ {{ note.title or "Catatan Baru" }}
    </a>
</ul>
{% endblock %}

{% block content %}

<form method="POST" id="saveForm">
    <div class="mb-3">
        <input type="text" name="title" class="form-control form-control-lg" placeholder="Judul catatan..."
            value="{{ note.title }}">
    </div>

    <div class="mb-3">
        <!-- Contenteditable div -->
        <div id="editor" contenteditable="true" class="form-control" style="min-height:200px; white-space: pre-wrap;">{{
            note.content }}</div>
        <div id="suggestion" style="color: gray; margin-top:5px;"></div>

        <!-- Hidden input supaya bisa disubmit ke DB -->
        <input type="hidden" name="content" id="contentHidden">
    </div>

    <button class="btn btn-success">
        <i class="fi fi-rr-disk"> Simpan</i>
    </button>
</form>

<hr>

<!-- FORM HAPUS -->
<form method="POST" action="{{ url_for('notes_bp.delete', note_id=note.id) }}"
    onsubmit="return confirm('Yakin hapus catatan ini, Bang?')">
    <button class="btn btn-danger">
        <i class="fi fi-rr-trash"> Hapus</i>
    </button>
</form>

<script>
    const editor = document.getElementById("editor");
    const suggestionDiv = document.getElementById("suggestion");
    const hiddenInput = document.getElementById("contentHidden");

    let suggestion = "";
    let triggerTimer = null;
    let lastText = "";

    // trigger via SPACE atau ENTER
    editor.addEventListener("keydown", (e) => {
        if (e.key === " " || e.key === "Enter") {
            clearTimeout(triggerTimer);

            triggerTimer = setTimeout(() => {
                const text = editor.innerText.trim();

                if (text.length < 3 || text === lastText) return;

                lastText = text;
                requestSuggestion(text);
            }, 2000); // ⏱ 2 detik setelah Space / Enter
        }

        // Tab → apply suggestion
        if (e.key === "Tab" && suggestion) {
            e.preventDefault();
            editor.innerText += suggestion;
            suggestion = "";
            suggestionDiv.innerText = "";
        }
    });

    async function requestSuggestion(text) {
        try {
            const res = await fetch(`/notes/{{ note.id }}/suggest`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text })
            });

            const data = await res.json();
            suggestion = data.suggestion || "";
            suggestionDiv.innerText = suggestion;

            console.log("AI Suggestion:", suggestion);
        } catch (err) {
            console.error("AI error:", err);
        }
    }

    // submit form → ambil teks editor
    document.getElementById("saveForm").addEventListener("submit", () => {
        hiddenInput.value = editor.innerText;
    });
</script>


{% endblock %}