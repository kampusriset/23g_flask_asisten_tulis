{% extends "base/sidebar.html" %}

{% block sidebar %}
<ul class="list-group list-group-flush">
    <a href="{{ url_for('notes_bp.edit', note_id=note.id) }}" class="list-group-item active">
        ✏️ {{ note.title or "Catatan Baru" }}
    </a>
</ul>
{% endblock %}

{% block content %}

<!-- FORM SIMPAN -->
<form method="POST">
    <div class="mb-3">
        <input type="text" name="title" class="form-control form-control-lg" placeholder="Judul catatan..."
            value="{{ note.title }}">
    </div>

    <div class="mb-3">
        <div id="editor" contenteditable="true" class="form-control" style="min-height:200px; white-space: pre-wrap;">{{
            note.content }}</div>
    </div>



    <script>
        const editor = document.getElementById("editor");
        let suggestion = "";
        let debounceTimer = null;

        editor.addEventListener("input", () => {
            clearTimeout(debounceTimer);

            const text = editor.innerText;
            if (text.trim().length < 3) {
                suggestion = "";
                renderEditor(text, suggestion);
                return;
            }

            debounceTimer = setTimeout(async () => {
                try {
                    const res = await fetch(`{{ url_for('notes_bp.note_suggest', note_id=note.id) }}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ text })
                    });
                    const data = await res.json();
                    suggestion = data.suggestion ? data.suggestion.slice(text.length) : "";
                    renderEditor(text, suggestion);
                } catch (err) {
                    console.error(err);
                }
            }, 1000); // delay 1 detik
        });

        // fungsi render teks + saran
        function renderEditor(text, suggestion) {
            editor.innerHTML = text +
                (suggestion ? `<span style="color:gray;">${suggestion}</span>` : "");
            placeCaretAtEnd(editor);
        }

        // fungsi biar caret tetep di akhir teks user
        function placeCaretAtEnd(el) {
            el.focus();
            if (typeof window.getSelection != "undefined"
                && typeof document.createRange != "undefined") {
                var range = document.createRange();
                range.selectNodeContents(el);
                range.collapse(false);
                var sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }

        // Tab untuk apply suggestion
        editor.addEventListener("keydown", (e) => {
            if (e.key === "Tab" && suggestion) {
                e.preventDefault();
                editor.innerText += suggestion;
                suggestion = "";
            }
        });
    </script>




    <button class="btn btn-success">
        <i class="fi fi-rr-disk"> Simpan</i>
    </button>
</form>

<hr>

<!-- FORM HAPUS -->
<form method="POST" action="{{ url_for('notes_bp.delete', note_id=note.id) }}"
    onsubmit="return confirm('Yakin hapus catatan ini, Bang?')">
    <button class="btn btn-danger">
        <i class="fi fi-rr-trash"> Hapus</i>
    </button>
</form>

{% endblock %}