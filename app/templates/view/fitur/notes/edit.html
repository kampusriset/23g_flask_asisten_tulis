{% extends "base/sidebar.html" %}

{% block sidebar %}
<ul class="list-group list-group-flush">
    <a href="{{ url_for('notes_bp.edit', note_id=note.id) }}" class="list-group-item active">
        ✏️ {{ note.title or "Catatan Baru" }}
    </a>
</ul>
{% endblock %}

{% block content %}
<div style="display:flex; justify-content:center; margin-top:50px;">
    <div style="width:60%;">

        <form method="POST" id="saveForm">

            <!-- JUDUL -->
            <!-- JUDUL -->
            <div class="mb-3">
                <input type="text" name="title" class="form-control placeholder-input"
                    placeholder="Judul catatan baru..." value="{{ note.title }}" style="
            width: 100%;
            background: transparent;
            border: none;
            box-shadow: none;
            font-size: 1.5rem;
            font-weight: bold;
            outline: none;
            color: inherit;
        ">
            </div>


            <!-- KONTEN -->
            <div class="mb-3 position-relative" style="min-height:300px;">

                <!-- GHOST SUGGESTION -->
                <div id="ghost" class="form-control" style="
                    min-height:300px;
                    white-space:pre-wrap;
                    color:#aaa;
                    position:absolute;
                    top:0;
                    left:0;
                    pointer-events:none;
                    background:transparent;
                    border:none;
                    box-shadow:none;
                "></div>

                <!-- EDITOR ASLI -->
                <div id="editor" contenteditable="true" class="form-control editable-div"
                    data-placeholder="Tulis apapun disini..." style="
                        min-height:300px;
                        background:transparent;
                        position:relative;
                        border:none;
                        box-shadow:none;
                        outline:none;
                        white-space:pre-wrap;
                    ">{{ note.content }}</div>

                <input type="hidden" name="content" id="contentHidden">
            </div>

            <button class="btn btn-success">
                <i class="fi fi-rr-disk"> Simpan</i>
            </button>
        </form>

        <hr>

        <!-- FORM HAPUS -->
        <form method="POST" action="{{ url_for('notes_bp.delete', note_id=note.id) }}"
            onsubmit="return confirm('Yakin hapus catatan ini, Bang?')">
            <button class="btn btn-danger">
                <i class="fi fi-rr-trash"> Hapus</i>
            </button>
        </form>
    </div>
</div>

<style>
    /* placeholder untuk div contenteditable */
    .editable-div:empty::before {
        content: attr(data-placeholder);
        color: #aaa;
        pointer-events: none;
        display: block;
    }
</style>

<script>
    const editor = document.getElementById("editor");
    const ghost = document.getElementById("ghost");
    const hiddenInput = document.getElementById("contentHidden");

    let suggestion = "";
    let debounceTimer = null;
    let lastText = "";

    /* --------------------
       helper
    -------------------- */
    function clearSuggestion() {
        suggestion = "";
        syncGhost();
    }

    function syncGhost() {
        ghost.innerText = editor.innerText + suggestion;
    }

    editor.addEventListener("input", () => {
        syncGhost();
    });

    /* --------------------
       key handling
    -------------------- */
    editor.addEventListener("keydown", (e) => {
        if (e.key === "Tab" && suggestion) {
            e.preventDefault();
            editor.innerText += suggestion;
            clearSuggestion();
            moveCursorToEnd(editor);
            return;
        }

        if (suggestion && (e.key.length === 1 || e.key === "Backspace" || e.key === "Enter")) {
            clearSuggestion();
            return;
        }

        if (suggestion && ["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown", "Escape"].includes(e.key)) {
            clearSuggestion();
            return;
        }

        if (e.key === " ") {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const lastLine = editor.innerText.split("\n").pop().trim();
                if (lastLine.length < 3 || lastLine === lastText) return;
                lastText = lastLine;
                requestSuggestion(lastLine);
            }, 2000);
        }
    });

    /* --------------------
       call backend
    -------------------- */
    async function requestSuggestion(text) {
        try {
            const res = await fetch(`/notes/{{ note.id }}/suggest`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text })
            });
            const data = await res.json();
            suggestion = data.suggestion ? "" + data.suggestion : "";
            syncGhost();
        } catch (err) {
            console.error("AI error:", err);
        }
    }

    /* --------------------
       cursor helper
    -------------------- */
    function moveCursorToEnd(el) {
        el.focus();
        const range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
    }

    /* --------------------
       submit → DB
    -------------------- */
    document.getElementById("saveForm").addEventListener("submit", () => {
        hiddenInput.value = editor.innerText;
    });
</script>

{% endblock %}