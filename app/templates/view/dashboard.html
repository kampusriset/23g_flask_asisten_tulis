{% extends "base/sidebar.html" %}

{% block content %}
{% set login_messages = [] %}
{% for category, message in get_flashed_messages(with_categories=true) %}
{% if category == 'login_success' %}
{% set _ = login_messages.append(message) %}
{% endif %}
{% endfor %}

{% if login_messages %}


<div id="login-toast" class="fixed top-6 right-6 z-[9999] bg-white border border-green-400
            shadow-lg rounded-xl px-6 py-4 flex items-start gap-3
            animate-toast-in">

    <div class="text-green-500 text-xl">✔</div>
    <div>
        <p class="font-semibold text-gray-800">Login Berhasil</p>
        <p class="text-sm text-gray-600">{{ login_messages[0] }}</p>
    </div>
</div>

<script>
    setTimeout(() => {
        const toast = document.getElementById('login-toast');
        toast && toast.classList.replace('animate-toast-in', 'animate-toast-out');
        setTimeout(() => toast && toast.remove(), 2000);
    }, 2500);
</script>
{% endif %}

<!-- Notes Section -->
<div class="p-6 text-gray-200 mt-6">
    {% if greeting %}
    <div class="mb-12 text-center">
        <h1 class="text-2xl font-semibold text-black">
            {{ greeting }}
        </h1>
        <div class="mt-2 text-sm text-gray-400">
            Semoga harimu menyenangkan ✨
        </div>
    </div>
    {% endif %}

    <div class="mx-auto w-full max-w-4xl">
        <div class="flex items-center justify-between mb-4">
            <div class="text-sm text-gray-400">Catatan Saya</div>
            <!-- tombol tambah kini menjadi kartu 'Catatan Baru' di dalam grid -->
        </div>


        {% if notes and notes|length > 0 %}
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 justify-center">
            <!-- New note card (first item) -->
            <a href="{{ url_for('notes_bp.new_note') }}"
                class="block rounded-xl bg-zinc-800 hover:bg-zinc-700 transition p-4 overflow-hidden flex flex-col justify-center items-center text-center"
                style="aspect-ratio:1 / 1;">
                <div class="text-3xl text-white font-bold">+</div>
                <div class="mt-2 text-sm text-gray-300">Catatan Baru</div>
            </a>

            {% for note in notes %}
            <a href="{{ url_for('notes_bp.edit', note_id=note.id) }}"
                class="block rounded-xl bg-zinc-800 hover:bg-zinc-700 transition p-4 overflow-hidden flex flex-col justify-between"
                style="aspect-ratio:1 / 1;">
                <div class="font-medium text-white truncate"><i class="fi fi-rr-document mr-2"></i>{{ note.title.strip()
                    if note.title and note.title.strip()
                    else
                    'Catatan Baru' }}</div>
                <div class="mt-2 text-xs text-gray-400">{{ note.updated_at.strftime('%d %b %Y, %H:%M') if
                    note.updated_at
                    else (note.created_at.strftime('%d %b %Y, %H:%M') if note.created_at else '') }}</div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <div class="grid place-items-center">
            <a href="{{ url_for('notes_bp.new_note') }}"
                class="block rounded-xl bg-zinc-800 hover:bg-zinc-700 transition p-4 overflow-hidden flex flex-col justify-center items-center text-center"
                style="width:220px;aspect-ratio:1 / 1;">
                <div class="text-3xl text-white font-bold">+</div>
                <div class="mt-2 text-sm text-gray-300">Catatan Baru</div>
            </a>
        </div>
        {% endif %}

        <!-- Rapat Section -->
        <div class="mt-8">
            <div class="flex items-center justify-between mb-4">
                <div class="text-sm text-gray-400">Rapat Saya</div>
                <div>
                    <a href="{{ url_for('rapat_bp.rapat') }}" class="text-sm text-gray-400 hover:underline">Lihat
                        semua</a>
                </div>
            </div>

            {% if rapats and rapats|length > 0 %}
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                {% for r in rapats %}
                <a href="{{ url_for('rapat_bp.detail_rapat', id=r.id) }}"
                    class="block rounded-lg bg-zinc-800 hover:bg-zinc-700 p-4">
                    <div class="font-medium text-white truncate"><i class="fi fi-rr-users-alt mr-2"></i>{{ r.topik }}
                    </div>
                    <div class="mt-2 text-xs text-gray-400">{{ r.tanggal.strftime('%d %b %Y') if r.tanggal else '' }}
                    </div>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <div class="rounded-xl bg-zinc-800 p-4 text-gray-400 text-center">
                Belum ada rapat. <a href="{{ url_for('rapat_bp.rapat') }}" class="text-blue-400 hover:underline">Buat
                    atau lihat rapat</a>
            </div>
            {% endif %}
        </div>



        <div class="mt-12 space-y-8">

            <div class="flex flex-wrap gap-3 mb-6">

                <select id="filterType" class="bg-zinc-900 text-gray-200 border border-zinc-700
               rounded-lg px-4 py-2 text-sm
               focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="weekly">Mingguan</option>
                    <option value="monthly">Bulanan</option>
                    <option value="yearly">Tahunan</option>
                </select>

                <select id="yearSelect" class="bg-zinc-900 text-gray-200 border border-zinc-700
               rounded-lg px-4 py-2 text-sm
               focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    {% for y in range(2022, 2031) %}
                    <option value="{{ y }}">{{ y }}</option>
                    {% endfor %}
                </select>

                <select id="monthSelect" class="bg-zinc-900 text-gray-200 border border-zinc-700
               rounded-lg px-4 py-2 text-sm
               focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    {% for m in range(1,13) %}
                    <option value="{{ m }}">{{ m }}</option>
                    {% endfor %}
                </select>

            </div>

            <!-- GRAFIK CATATAN -->
            <div class="bg-zinc-900 rounded-2xl p-6">
                <i class="fi fi-rr-document mr-2"> </i>
                <h2 class="text-base text-gray-300 mb-5">
                    Catatan (7 Hari Terakhir)
                </h2>
                <canvas id="notesChart" height="260"></canvas>
            </div>

            <!-- GRAFIK RAPAT -->
            <div class="bg-zinc-900 rounded-2xl p-6">
                <i class="fi fi-rr-users-alt mr-2"> </i>
                <h2 class="text-base text-gray-300 mb-5">
                    Rapat (7 Hari Terakhir)
                </h2>
                <canvas id="rapatChart" height="260"></canvas>
            </div>

        </div>



    </div>
</div>



<script>
    async function loadChart(filter = "weekly") {
        const year = document.getElementById("yearSelect").value;
        const month = document.getElementById("monthSelect").value;

        const res = await fetch(
            `/dashboard/chart-data?filter=${filter}&year=${year}&month=${month}`
        );

        const data = await res.json();

        notesChart.data.labels = data.labels;
        notesChart.data.datasets[0].data = data.notes;
        notesChart.update();

        rapatChart.data.labels = data.labels;
        rapatChart.data.datasets[0].data = data.rapat;
        rapatChart.update();
    }

    document.getElementById("filterType").addEventListener("change", e => {
        loadChart(e.target.value);
    });

    document.getElementById("yearSelect").addEventListener("change", () => {
        loadChart(filterType.value);
    });

    document.getElementById("monthSelect").addEventListener("change", () => {
        loadChart(filterType.value);
    });

    document.getElementById('filterType').addEventListener('change', e => {
        const month = document.getElementById('monthSelect');
        month.classList.toggle('hidden', e.target.value === 'yearly');
    });

    const filterType = document.getElementById('filterType');
    const yearSelect = document.getElementById('yearSelect');
    const monthSelect = document.getElementById('monthSelect');

    function updateFilterVisibility() {
        const type = filterType.value;

        if (type === 'weekly') {
            // Mingguan → sembunyikan tahun & bulan
            yearSelect.classList.add('hidden');
            monthSelect.classList.add('hidden');
        }
        else if (type === 'monthly') {
            // Bulanan → tampilkan tahun & bulan
            yearSelect.classList.remove('hidden');
            monthSelect.classList.remove('hidden');
        }
        else if (type === 'yearly') {
            // Tahunan → tampilkan tahun, sembunyikan bulan
            yearSelect.classList.remove('hidden');
            monthSelect.classList.add('hidden');
        }
    }

    // init saat page load
    updateFilterVisibility();

    // event change
    filterType.addEventListener('change', updateFilterVisibility);

</script>

<script>
    loadChart('weekly'); // default saat halaman dibuka
</script>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const notesChart = new Chart(
        document.getElementById('notesChart'),
        {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Catatan',
                    data: [],
                    backgroundColor: 'rgba(52,211,153,0.5)'
                }]
            }
        }
    );

    const rapatChart = new Chart(
        document.getElementById('rapatChart'),
        {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Rapat',
                    data: [],
                    borderColor: '#60a5fa',
                    fill: false
                }]
            }
        }
    );
</script>


<script>
    const rapatCtx = document.getElementById('rapatChart').getContext('2d');

    new Chart(rapatCtx, {
        type: 'line',
        data: {
            labels: chartLabels,
            datasets: [{
                label: 'Rapat',
                data: rapatData,
                borderColor: '#60a5fa',
                backgroundColor: 'rgba(96,165,250,0.2)',
                tension: 0.4,
                fill: true,
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            }
        }
    });
</script>







{% endblock %}